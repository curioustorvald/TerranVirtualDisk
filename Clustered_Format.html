<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>Virtual Block Filesystem</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}

</style></head><body><article id="3b0fd0c1-1b85-45b0-aeed-5e6e8656a7c0" class="page sans"><header><h1 class="page-title">Virtual Block Filesystem</h1><p class="page-description"></p></header><div class="page-body"><figure class="block-color-gray_background callout" style="white-space:pre-wrap;display:flex" id="af507272-3cb8-49f7-9ccd-c5cc290042c4"><div style="font-size:1.5em"><span class="icon">😵</span></div><div style="width:100%">Comes with all the inconveniences of FAT!</div></figure><p id="c5b97b57-9860-4e9c-aa23-7fe4badd255f" class="">The filesystem is consisted of 4096-byte blocks — a number coincides with the cluster size of the modern “host” filesystem.</p><p id="cef9f78a-04be-4541-b552-31ba0b650d85" class="">Everything will be a block — the header, file allocation table, the actual file, etc.</p><p id="9e454a95-e1f9-4009-be46-81e0cc66bb8d" class="">Implementation using different block sizes is possible, and they must be given a version number other than 0x11</p><p id="a2ce9702-c72b-4abb-be78-d9e892e8f7f0" class="">Endianness: Big</p><nav id="91c79a82-2345-40d0-a940-d1cc1be4b650" class="block-color-gray table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#c36cf700-c113-4b91-bbf3-df4a9fd60969">Blocks Overview</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#1c1c0eaf-77f6-4af5-ac89-9e01c907e8ca">Blocks</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#6b1f434f-3ac7-4a2b-96e6-64ade36873e8">Header Block</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#0b11aba0-8c90-4683-a537-d130675f92e4">Structure</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#60ce99f3-1a76-47f2-80f2-6d65dc92ef95">Boot Sector Block</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#224bc0c2-abbc-4d3e-9db1-db95dacafb7d">File Allocation Table Block</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#df84729c-24e1-44a0-aeba-e91e722a2c3e">File Entry Structure</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#13d0420f-bf54-4dc2-9fff-243476d5b283">Reserved Clusters</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#01b90e0d-c7b0-4b33-9a7b-d31a19fbbfd9">File Block</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#1b6be334-0f57-40b0-ac50-63cef15e4404">Structure</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#4253ef69-6fc5-4429-8dd9-42da6efff2ec">Directory File Contents</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f73b8864-e9cf-48fe-bcb3-2c81df56c447">Binary File Contents</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#feb43a3f-dc67-4a72-8816-0012924e5fe9">Filesystem-Special Files</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#553be37e-a668-4b04-b945-c797dc0cc923">0xF0 — Copy-on-Write Siblings</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f72673b7-bcff-488d-83f7-1ad5cfcc243c">Structure</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#6b419640-f057-4e3e-8774-51e5babb8af3">When Does the File ID Change?</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#bd9d2930-9b77-4ff4-a5b5-ed403acc0587">Functions</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0e655231-d926-4c6c-a2f0-30551503bfd8">Disk Management Functions</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#0cb7729d-fd52-4484-9c36-877e99609bcc">private renum(increment: Int)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#34bd866b-fdb4-42f0-af06-095ca25fd8b2">public defrag(option: Int = 0)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#dff465ff-f06e-4665-8df7-2234c4aece2b">public growFAT()</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2567a07c-202d-4521-9888-ffb6e59a065e">public allocateFile(size: Int): FATEntry</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#4fdbe9c6-f198-4968-8ba0-edcd49c54f98">public getFile(clusterNumber: Int): FATEntry?</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#549018c9-7368-444c-9918-3f1e74818a4e">public deleteFile(clusterNumber: Int)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f21501cc-fd2a-4708-a74a-180dac5c3518">public writeBytes(entry: FATEntry, buffer: ByteArray, bufferOffset: Int, writeLength: Int, fileOffset: Int)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#519f86d4-8d14-4c1c-a429-bbd9c3f3c055">public readBytes(entry: FATEntry, length: Int, offset: Int): ByteArray</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#774a1cdf-57c4-4a38-bb96-e562adda624b">public readBytes(entry: FATEntry, buffer: ByteArray, bufferOffset: Int, readLength: Int, readOffset: Int): Int</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#d81660f6-ba50-4626-96fd-2fdfbaf69c84">public setFileLength(entry: FATEntry, newLength: Int)</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#8d306480-ead1-47db-a114-7fadfeecdf57">public getFileLength(entry: FATEntry): Int</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#977e7a9e-fc9f-4fa5-82b4-56ae041b0f67">public addSubEntry(entry: FATEntry, clusterNumbers: List&lt;Int&gt;)</a></div></nav><h1 id="c36cf700-c113-4b91-bbf3-df4a9fd60969" class="">Blocks Overview</h1><table id="20ee545d-9220-4ef3-931e-bafd96976a1b" class="simple-table"><thead class="simple-table-header"><tr id="e4548885-c4a5-4fa5-8cfb-97d4d5e5175e"><th id="xqy]" class="simple-table-header-color simple-table-header">Offset</th><th id="eM?&gt;" class="simple-table-header-color simple-table-header" style="width:255px">Description</th></tr></thead><tbody><tr id="be7b4bb1-2201-4b75-a21d-9717997dc056"><td id="xqy]" class="">0</td><td id="eM?&gt;" class="" style="width:255px">Header</td></tr><tr id="73cece56-f255-4242-b2e8-18f11251e2f7"><td id="xqy]" class="">1</td><td id="eM?&gt;" class="" style="width:255px">Boot sector</td></tr><tr id="63096e64-b6fc-4b80-aaac-894deada2af7"><td id="xqy]" class="">2..3(7,15,31,63,…)</td><td id="eM?&gt;" class="" style="width:255px">File Allocation Table</td></tr><tr id="0ef75017-3b83-43b6-bbeb-5f1ab1c0d5ad"><td id="xqy]" class="">varies</td><td id="eM?&gt;" class="" style="width:255px">File</td></tr></tbody></table><h1 id="1c1c0eaf-77f6-4af5-ac89-9e01c907e8ca" class="">Blocks</h1><p id="03ce08f4-5b67-4751-b79a-16a48e530829" class="">The Block ID is the block “offset” from the beginning of the archive. </p><p id="52ca7ee7-1f69-46a2-8c7a-7544436e90e5" class="">An archive can have 16777216 blocks (max 64 GB)</p><h2 id="6b1f434f-3ac7-4a2b-96e6-64ade36873e8" class="">Header Block</h2><p id="d0e77ef4-4021-463e-8a80-78929994880a" class="">1 Block size</p><h3 id="0b11aba0-8c90-4683-a537-d130675f92e4" class="">Structure</h3><table id="c1483187-6cec-44c6-aeeb-d5a04d7d9c41" class="simple-table"><thead class="simple-table-header"><tr id="2c6b0613-d447-4fae-813d-c9785f6250b2"><th id="dWPX" class="simple-table-header-color simple-table-header" style="width:81px">Offset</th><th id="reN{" class="simple-table-header-color simple-table-header">Type</th><th id="Kkfb" class="simple-table-header-color simple-table-header" style="width:330px">Description</th></tr></thead><tbody><tr id="b71cf30f-d5f4-41a5-95f6-e5bbf3c81d59"><td id="dWPX" class="" style="width:81px">0</td><td id="reN{" class=""><strong>“TEVd”</strong></td><td id="Kkfb" class="" style="width:330px">Magic</td></tr><tr id="23cbaeb9-1911-4c5d-86dd-2c38d4c4cf97"><td id="dWPX" class="" style="width:81px">4</td><td id="reN{" class="">Uint48</td><td id="Kkfb" class="" style="width:330px">Disk size in bytes</td></tr><tr id="a0183db5-04f3-400b-989e-6eaee20e17fe"><td id="dWPX" class="" style="width:81px">10</td><td id="reN{" class="">Byte[32]</td><td id="Kkfb" class="" style="width:330px">Disk name</td></tr><tr id="2db95eab-fa44-4bef-b7d1-2deeaa528766"><td id="dWPX" class="" style="width:81px">42</td><td id="reN{" class="">Int32</td><td id="Kkfb" class="" style="width:330px">CRC-32</td></tr><tr id="1fd560ec-c94c-4f24-921d-6a7352ca5db1"><td id="dWPX" class="" style="width:81px">46</td><td id="reN{" class=""><strong>0x11</strong></td><td id="Kkfb" class="" style="width:330px">Version</td></tr><tr id="b4a254ca-8bf3-4ce8-9317-4792dd200c4e"><td id="dWPX" class="" style="width:81px">47</td><td id="reN{" class="">Byte</td><td id="Kkfb" class="" style="width:330px">Primary Attribute</td></tr><tr id="4b7b5a57-c92f-413b-bcc0-f08395d9d9cd"><td id="dWPX" class="" style="width:81px">48</td><td id="reN{" class="">Byte[16]</td><td id="Kkfb"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         class="" style="width:330px">User-defined Attributes</td></tr><tr id="16a62c3a-f541-455d-84bd-77191f218901"><td id="dWPX" class="" style="width:81px">64</td><td id="reN{" class="">Uint32</td><td id="Kkfb" class="" style="width:330px">FAT size in blocks</td></tr><tr id="bfb3603d-d42b-4e71-92cd-e5da3aedbea6"><td id="dWPX" class="" style="width:81px">68</td><td id="reN{" class="">Uint8</td><td id="Kkfb" class="" style="width:330px">Charset — Primary Classification</td></tr><tr id="7a26d0b7-1d3c-4821-a4b4-c885e4dac164"><td id="dWPX" class="" style="width:81px">69</td><td id="reN{" class="">Uint8</td><td id="Kkfb" class="" style="width:330px">Charset — Secondary Classification</td></tr><tr id="b08dd503-2b2a-4da6-b869-a985bea69de7"><td id="dWPX" class="" style="width:81px">70</td><td id="reN{" class="">Byte[4026]</td><td id="Kkfb" class="" style="width:330px">Unused</td></tr></tbody></table><figure id="85a1849f-de5f-4258-9dce-f710b131357b" class="link-to-page"><a href="https://www.notion.so/User-Defined-Attributes-85a1849fde5f42589dcef710b131357b">User-Defined Attributes</a></figure><ul id="32cedeea-6ed8-435f-9bec-e99c71064a68" class="bulleted-list"><li style="list-style-type:disc">Primary Attribute (1 byte)<table id="90624fd9-6c1f-4dd5-bca9-76bb21947d06" class="simple-table"><tbody><tr id="2725465c-2fda-4dda-94ae-5af457696f8f"><td id="Y?r&gt;" class="" style="width:31.23333740234375px">—</td><td id="jZLC" class="" style="width:31.23333740234375px">—</td><td id="W@?_" class="" style="width:31.23333740234375px">—</td><td id="&lt;{ei" class="" style="width:33px">—</td><td id="FZGk" class="" style="width:31.23333740234375px">—</td><td id="Dp|R" class="" style="width:31.23333740234375px">—</td><td id="FX\~" class="" style="width:31.23333740234375px">—</td><td id="?nP[" class="" style="width:93.60000610351562px">Read-only?</td></tr></tbody></table></li></ul><ul id="be1ca6a2-15aa-4ad9-b1ae-f37d549a114b" class="bulleted-list"><li style="list-style-type:disc">Charsets<table id="a97902ae-feb2-4be9-9575-ac1e42f4ab0f" class="simple-table"><thead class="simple-table-header"><tr id="fa34011a-3db3-4191-9dc2-7988ba7156fb"><th id="{^kx" class="simple-table-header-color simple-table-header" style="width:58.19999694824219px">Bytes</th><th id="vUfU" class="simple-table-header-color simple-table-header" style="width:323.70001220703125px">Name</th></tr></thead><tbody><tr id="e3c6d765-d0f0-41c8-9ff9-2fe6546e2512"><td id="{^kx" class="" style="width:58.19999694824219px">00 00</td><td id="vUfU" class="" style="width:323.70001220703125px">Pure ASCII / CP437</td></tr><tr id="98065931-436c-4051-a4ce-3fcfeb540afe"><td id="{^kx" class="" style="width:58.19999694824219px">01 ..</td><td id="vUfU" class="" style="width:323.70001220703125px">ISO 8859-x series</td></tr><tr id="4901ab24-72f0-4c57-bd42-6992b26ef407"><td id="{^kx" class="" style="width:58.19999694824219px">01 00</td><td id="vUfU" class="" style="width:323.70001220703125px">ISO 8859-1</td></tr><tr id="cf825241-575a-4b62-a0fe-9a37e0442f01"><td id="{^kx" class="" style="width:58.19999694824219px">01 01</td><td id="vUfU" class="" style="width:323.70001220703125px">ISO 8859-2</td></tr><tr id="e7176595-faf5-4a00-8d5d-50ad45fb2d49"><td id="{^kx" class="" style="width:58.19999694824219px">…</td><td id="vUfU" class="" style="width:323.70001220703125px">…</td></tr><tr id="bf38b09d-d2a4-49e0-8a73-2b81b185d86e"><td id="{^kx" class="" style="width:58.19999694824219px">01 0F</td><td id="vUfU" class="" style="width:323.70001220703125px">ISO 8859-16</td></tr><tr id="1982162d-2fbc-4d20-90c6-6e762b6e106f"><td id="{^kx" class="" style="width:58.19999694824219px">10 00</td><td id="vUfU" class="" style="width:323.70001220703125px">UTF-8</td></tr><tr id="571d20ca-9475-4a4c-8529-726fb3059d10"><td id="{^kx" class="" style="width:58.19999694824219px">10 01</td><td id="vUfU" class="" style="width:323.70001220703125px">UTF-16BE</td></tr><tr id="215127d6-f7a3-4686-9509-b1639bc0ec86"><td id="{^kx" class="" style="width:58.19999694824219px">10 02</td><td id="vUfU" class="" style="width:323.70001220703125px">UTF-16LE</td></tr></tbody></table></li></ul><h2 id="60ce99f3-1a76-47f2-80f2-6d65dc92ef95" class="">Boot Sector Block</h2><p id="32bfbc4c-e473-4428-a1b5-9ccce1df97b6" class="">1 Block size, “raw” formatted (has no structure, all 4096 bytes holds the actual data)</p><p id="99a6b91b-67ca-4c1b-a4de-bd3c3bbe90fd" class="">The very first byte must not be null (\x00) or space (\x20) to be recognised as bootable</p><h2 id="224bc0c2-abbc-4d3e-9db1-db95dacafb7d" class="">File Allocation Table Block</h2><ul id="c82c1c73-8b9f-47dc-99e1-c0b5c49bb970" class="bulleted-list"><li style="list-style-type:disc">16 entries per block with each entry is 256 bytes long</li></ul><ul id="f40ee6fd-fb1e-476d-9fe5-9ba47be72fe4" class="bulleted-list"><li style="list-style-type:disc">Block growing must be done in a way that (# of FAT + 2) is always power of 2<ul id="be3332cf-d5a9-4df2-adab-4433c484cf39" class="bulleted-list"><li style="list-style-type:circle">e.g. FAT block count must be 2→6→14→30→62→126→254→…</li></ul></li></ul><ul id="85134824-317a-4521-9b0a-432ce06a91c2" class="bulleted-list"><li style="list-style-type:disc">FATs must have no gaps in-between<ul id="466a14b3-e5ce-4539-9d51-8e537945a760" class="bulleted-list"><li style="list-style-type:circle">Extended Entries must occur right after the master entry, and multiple Extended Entries must be stored contiguously, ascending from zero</li></ul></li></ul><ul id="f56d5e95-31dd-4b3a-911b-77d198f1ca90" class="bulleted-list"><li style="list-style-type:disc">FATs and Extended Entries are “recommended” to be sorted</li></ul><ul id="1851ceb5-2766-4748-83d7-cf12cf77e25b" class="bulleted-list"><li style="list-style-type:disc">The very first entry on the FAT must be the root directory</li></ul><h3 id="df84729c-24e1-44a0-aeba-e91e722a2c3e" class="">File Entry Structure</h3><table id="c6e71d36-9f1d-4986-9ea1-82094c0e3ae5" class="simple-table"><tbody><tr id="78f13e6d-c21c-497c-8e7e-b920d83afcfe"><td id="c|XL" class="" style="width:126.16667175292969px">Pointer to Cluster
    <br />(3 bytes)</td><td id="{hw_" class="" style="width:69.05000305175781px">Flags
    <br />(1 byte)</td><td id="iEge" class="" style="width:105px">Creation Date
    <br />(6 bytes)</td><td id="d?R?" class="" style="width:126.93333435058594px">Modification Date
    <br />(6 bytes)</td><td id="k:&lt;d" class="" style="width:136px">Filename
    <br />(220 bytes)</td><td id="?FXh" class="" style="width:100.61666870117188px">Future Use
    <br />(16 bytes)</td><td id="Uthi" class="" style="width:97px"><mark class="highlight-gray"><em>Node Index
    <br />(4 bytes)</em></mark></td></tr></tbody></table><ul id="234c0695-23c6-4120-bf0c-76a7deff0a31" class="bulleted-list"><li style="list-style-type:disc">Pointer to Cluster<ul id="3301e89a-eb21-40cb-88a9-d8ce83e5d5c9" class="bulleted-list"><li style="list-style-type:circle">The Cluster number is also used as a File ID<ul id="9179f5ff-9ffd-473f-8bb5-bc88c81084ad" class="bulleted-list"><li style="list-style-type:square">File IDs are by no means absolute and may change via certain actions; see <em>When Does the File ID Change?</em> below</li></ul></li></ul><ul id="95fd3b07-52f0-40d6-85e1-207b33026b87" class="bulleted-list"><li style="list-style-type:circle">Regular files must have a cluster number no larger than 0xF00000</li></ul><ul id="eebba77c-744a-4ea9-b99e-7dcbcf6be9fe" class="bulleted-list"><li style="list-style-type:circle">Files with no clusters allocated (e.g. Inline files) must have a cluster number 0xF00000..0xFFFEFF</li></ul><ul id="a3bc017a-6eb1-4bcb-bfb4-5bb17c380c35" class="bulleted-list"><li style="list-style-type:circle">Cluster number 0xFFFF00..0xFFFFFF is for internal use only </li></ul></li></ul><ul id="cb7e8df2-8e56-4288-aafd-b870495fd9e0" class="bulleted-list"><li style="list-style-type:disc">Flags<table id="d62eb635-355b-42d9-8e67-53e126519858" class="simple-table"><tbody><tr id="07b3270b-b02d-4437-96dd-1aa402ebf895"><td id="G;&gt;Z" class="" style="width:146.31666564941406px">Filetype
    <br />(4 bits)</td><td id="oWnA" class="" style="width:91.31666564941406px">Marked for removal?</td><td id="OdPy" class="" style="width:77.05000305175781px">System?</td><td id="SG~g" class="" style="width:72.11666870117188px">Hidden?</td><td id="ILtq" class="" style="width:94.36666870117188px">Read-only?</td></tr></tbody></table><ul id="c6f44b04-4e73-4427-8e61-eeddd8f0cc00" class="bulleted-list"><li style="list-style-type:circle">The System flag will mark the file as system-critical so that the file cannot be accidentally deleted. Damaged clusters are still be purged; this is not a “system” flag of the MS-DOS FAT. See Persistent flag on the cluster section for details.</li></ul></li></ul><ul id="67941e6c-7411-4532-baca-ffb58842ab78" class="bulleted-list"><li style="list-style-type:disc">Creation/Modification Date<ul id="0c89c8dd-67ba-4c56-ac26-077b2074ba39" class="bulleted-list"><li style="list-style-type:circle">Seconds since 1970-01-01T00:00:00Z in 48-bit unsigned integer</li></ul></li></ul><ul id="58590cd3-308f-455a-8117-3a4d24d803dc" class="bulleted-list"><li style="list-style-type:disc">Filename<ul id="d6cddda3-d88f-46f2-b5da-9323c0f6fb11" class="bulleted-list"><li style="list-style-type:circle">220 bytes, null-terminated except for the 220-char long name</li></ul></li></ul><ul id="e45ea161-b24c-4255-b86d-9051bee8db18" class="bulleted-list"><li style="list-style-type:disc">Node Index (reserved for future implementation)<ul id="99d1f6dc-d85c-4125-916b-5b8575965f09" class="bulleted-list"><li style="list-style-type:circle">Immutable and unique number given to the file. Somewhat analogous to the inode of the Unix system</li></ul></li></ul><h3 id="13d0420f-bf54-4dc2-9fff-243476d5b283" class="">Reserved Clusters</h3><ul id="41ab2657-925d-4aba-9112-f157bf5c36d7" class="bulleted-list"><li style="list-style-type:disc">When reading the archive, a file that points to cluster 0x000000 should be considered as uninitialised/invalid and must be discarded</li></ul><ul id="aaa7d56b-b586-4fd1-bde3-385f86d681bb" class="bulleted-list"><li style="list-style-type:disc">Inline files must have cluster number between 0xF00000 and 0xFFFDFF</li></ul><ul id="f9f85184-190e-4a68-a4a7-a7acf0c2cd40" class="bulleted-list"><li style="list-style-type:disc">Filesystem-special files must have cluster number between 0xFFFE00 and 0xFFFEFF</li></ul><ul id="d35dbad6-453b-4bee-b26b-d2d29e5f99e7" class="bulleted-list"><li style="list-style-type:disc">Inline file can also denote 0-byte file if no Type 16/17 Extended Entries are followed </li></ul><ul id="ab9d3f54-a87b-4851-b702-bd74be0243d5" class="bulleted-list"><li style="list-style-type:disc">Entry with Pointer of 0xFFFFxx denotes the Extended Entry<table id="89b043a7-daad-419c-817d-69efcf4755bc" class="simple-table"><tbody><tr id="2d108e65-35ad-490f-9787-582979314d31"><td id="YPTo" class="" style="width:67.98333740234375px">0xFFFF</td><td id="[[Rm" class="" style="width:69.05000305175781px">Type
    <br />(1 byte)</td><td id="=CQf" class="" style="width:95.56666564941406px">Parent ID
    <br />(3 bytes)</td><td id="Ugwi" class="" style="width:69.05000305175781px">Order
    <br />(1 byte)</td><td id="ixJb" class="" style="width:115.60000610351562px">Ext. Entry type
    <br />(1 byte)</td><td id="ZCzC" class="" style="width:218px">Payload
    <br />(248 bytes)</td></tr></tbody></table><ul id="959f9bd8-0c6d-4627-b406-2e3911651c8e" class="bulleted-list"><li style="list-style-type:circle">Type 0 — invalid</li></ul><ul id="2d58416b-a537-47df-b274-1c57f38f2bd6" class="bulleted-list"><li style="list-style-type:circle">Type 1 — Long Filename</li></ul><ul id="0a1c7ba0-2dcd-46b3-ae2e-7071ad83a80a" class="bulleted-list"><li style="list-style-type:circle">Type 2 — Extra time attributes</li></ul><ul id="3b741dfe-2701-4d6d-a576-0b4840dadab5" class="bulleted-list"><li style="list-style-type:circle">Type 3 — Extra flags attributes</li></ul><ul id="8fd7e5b9-d9eb-4b9a-a737-a6fa621d7723" class="bulleted-list"><li style="list-style-type:circle">Type 4 — POSIX Filesystem Permissions</li></ul><ul id="36fb22bb-b596-471b-8e20-f75284ecaba8" class="bulleted-list"><li style="list-style-type:circle">Type 17 — Inline binary file </li></ul><ul id="512a88b3-628f-4b08-b535-e495f53e5b94" class="bulleted-list"><li style="list-style-type:circle">Type 18 — Inline directory file</li></ul><ul id="9d5a9037-b1f1-4ff7-a474-10e314cf2830" class="bulleted-list"><li style="list-style-type:circle">Order is just an order between same types</li></ul><ul id="ee742f6d-75fa-44d7-a779-c811bedacb82" class="bulleted-list"><li style="list-style-type:circle">Extended Entries must be stored contiguously</li></ul><ul id="8dfdbbf9-c167-423e-a159-a705ab30104c" class="bulleted-list"><li style="list-style-type:circle">Extended Entries of the same type must be sorted by Order, but they may not be contiguous<ul id="791eb3a5-cc56-4776-b519-066d403e17d5" class="bulleted-list"><li style="list-style-type:square">following case is definitely possible<table id="0a8bd6f6-a0e1-426e-aa7e-f6c9d9c3abf9" class="simple-table"><tbody><tr id="db56ecd2-d244-46e2-8819-058447f6e184"><th id="Xf?x" class="simple-table-header-color simple-table-header" style="width:54.80000305175781px">Order</th><td id="Alc`" class="" style="width:26.783340454101562px">0</td><td id="MSpu" class="" style="width:26.783340454101562px">1</td><td id="yT:J" class="" style="width:34.56666564941406px">0</td><td id="ccka" class="" style="width:34.56666564941406px">1</td><td id="GJjX" class="" style="width:34.56666564941406px">2</td><td id="z\at" class="" style="width:26.783340454101562px">2</td><td id="ZOlQ" class="" style="width:26.783340454101562px">0</td><td id="wwwD" class="" style="width:26.783340454101562px">3</td><td id="ngTk" class="" style="width:34.56666564941406px">3</td><td id="TM[V" class="" style="width:34.56666564941406px">4</td></tr><tr id="4916eb4c-57b8-4ac2-9c3f-60f47643c0a3"><th id="Xf?x" class="simple-table-header-color simple-table-header" style="width:54.80000305175781px">Type</th><td id="Alc`" class="" style="width:26.783340454101562px">1</td><td id="MSpu" class="" style="width:26.783340454101562px">1</td><td id="yT:J" class="" style="width:34.56666564941406px">16</td><td id="ccka" class="" style="width:34.56666564941406px">16</td><td id="GJjX" class="" style="width:34.56666564941406px">16</td><td id="z\at" class="" style="width:26.783340454101562px">1</td><td id="ZOlQ" class="" style="width:26.783340454101562px">2</td><td id="wwwD" class="" style="width:26.783340454101562px">1</td><td id="ngTk" class="" style="width:34.56666564941406px">16</td><td id="TM[V" class="" style="width:34.56666564941406px">16</td></tr></tbody></table></li></ul></li></ul><h3 id="07df92bc-ab86-4512-bbf4-19479ced642f" class="">Type 1 Entry Format</h3><table id="c2a50375-3054-4404-9042-b688837ca8d0" class="simple-table"><tbody><tr id="5e9ad9c8-bc2f-4bf5-8c61-455b584bbab4"><td id="pvAY" class="" style="width:83.55000305175781px">0xFFFF01</td><td id="myLq" class="" style="width:120px">Parent ID
    <br />(3 bytes)</td><td id="LBaf" class="" style="width:69.05000305175781px">Order
    <br />(1 byte)</td><td id="UP{U" class="" style="width:85.26666259765625px"># of bytes
    <br />(1 byte)</td><td id="s&gt;rR" class="" style="width:271px">String
    <br />(248 bytes max)</td></tr></tbody></table><p id="8aba1b51-d439-4e48-8511-6134bbdf27fe" class="">Maximum length for the filename is (220 + 256 × 248 = 63708) bytes</p><p id="1e1082e1-2413-4583-971d-e07d19bc60fc" class="">NOTE: this filename format, unlike the filename on the FAT, is NOT null-terminated</p><h3 id="4f57a04f-38cb-4230-a525-418d208ab0a1" class="">Type 17 Entry Format</h3><table id="85e66e89-b80b-472f-a600-3574a1cb4762" class="simple-table"><tbody><tr id="071c1126-e447-46ae-9e87-6b1640694180"><td id="pvAY" class="" style="width:83.55000305175781px">0xFFFF11</td><td id="myLq" class="" style="width:120px">Parent ID
    <br />(3 bytes)</td><td id="LBaf" class="" style="width:69.05000305175781px">Order
    <br />(1 byte)</td><td id="UP{U" class="" style="width:85.26666259765625px"># of bytes
    <br />(1 byte)</td><td id="s&gt;rR" class="" style="width:271px">Data
    <br />(248 bytes max)</td></tr></tbody></table><p id="c3838923-63e6-4ba3-bb69-cb4919d6bf63" class="">Inline file can have theoretical maximum length of (256 × 248 = 63488) bytes</p><h3 id="902bade2-bd9c-423b-8922-606026f52941" class="">Type 18 Entry Format</h3><table id="e219583f-5dda-46eb-b78a-a4e3b59afbb8" class="simple-table"><tbody><tr id="4051c75c-9486-4af4-8221-3887e65328ee"><td id="pvAY" class="" style="width:83.55000305175781px">0xFFFF12</td><td id="myLq" class="" style="width:120px">Parent ID
    <br />(3 bytes)</td><td id="LBaf" class="" style="width:69.05000305175781px">Order
    <br />(1 byte)</td><td id="UP{U" class="" style="width:85.26666259765625px"># of bytes
    <br />(1 byte)</td><td id="s&gt;rR" class="" style="width:178px">Entries
    <br />(246 bytes max)</td><td id="=HrD" class="" style="width:103px">Empty Space
    <br />(\x00\x00)</td></tr></tbody></table><p id="c02a6169-7ad5-4729-a960-f33f04ca958b" class="">Inline directory can have theoretical maximum children of (256 × 82 = 20992) entries</p></li></ul><h2 id="01b90e0d-c7b0-4b33-9a7b-d31a19fbbfd9" class="">File Block</h2><h3 id="1b6be334-0f57-40b0-ac50-63cef15e4404" class="">Structure</h3><table id="7343dac6-064b-466c-a8d8-fe4dcc177b0a" class="simple-table"><tbody><tr id="0f3a77d7-58eb-474a-afba-fd3a01c78244"><td id="uVMa" class="" style="width:78.33332824707031px">Meta
    <br />(2 bytes)</td><td id="LPGn" class="" style="width:78.66667175292969px">Prev Ptr
    <br />(3 bytes)</td><td id="KusE" class="" style="width:78.66667175292969px">Next Ptr
    <br />(3 bytes)</td><td id="FC_y" class="" style="width:405px">Contents
    <br />(4088 bytes)</td></tr></tbody></table><ul id="a2b02b86-708b-43e7-9176-f49dae473ab1" class="bulleted-list"><li style="list-style-type:disc">Meta Byte 1<table id="175cb6bd-b028-4457-bec5-bfd870a7e36c" class="simple-table"><tbody><tr id="b724af27-74e0-4bd5-8ed5-5e9650c61da5"><td id="jGci" class="" style="width:80.21665954589844px">Discard?</td><td id="DU&lt;T" class="" style="width:31.23333740234375px">—</td><td id="&gt;s@|" class="" style="width:31.23333740234375px">—</td><td id="GlVR" class="" style="width:57.96665954589844px">Dirty?</td><td id="~x\?" class="" style="width:207px">Type ID (0..15)</td></tr></tbody></table><p id="81e6a3fa-ab13-4f1b-a6d4-da072005d82c" class="">The 4 flags are reserved for flagging bad clusters</p><table id="eb3c5bc9-20cc-492b-ba1f-65c526255dc2" class="simple-table"><thead class="simple-table-header"><tr id="64aabf94-28f1-4147-a393-7a0cfa95caca"><th id="Yrmk" class="simple-table-header-color simple-table-header" style="width:70.03334045410156px">Type ID</th><th id="~tRf" class="simple-table-header-color simple-table-header" style="width:333px">Description</th></tr></thead><tbody><tr id="f77a65cd-c4b2-40b5-bcbc-8579e972ae84"><td id="Yrmk" class="" style="width:70.03334045410156px">1</td><td id="~tRf" class="" style="width:333px">Binary File</td></tr><tr id="bc1b85f8-775d-4e61-8ef2-fe5748abbac2"><td id="Yrmk" class="" style="width:70.03334045410156px">2</td><td id="~tRf" class="" style="width:333px">Directory</td></tr></tbody></table><p id="c8e2e3ea-a3dd-49a3-a046-1ef31388fe50" class="">Note: the only purpose of the file type recording on the cluster is to see if the cluster is even used at all; get-filetype operation must refer to the FAT area instead of cluster flags</p></li></ul><ul id="e5e3db01-1cbe-4329-86d4-e4382a46bdc5" class="bulleted-list"><li style="list-style-type:disc">Meta Byte 2<table id="05ed7bc2-e3ef-41b0-a976-9dccbe844886" class="simple-table"><tbody><tr id="56a8186a-c6fc-4eff-9598-7bd74ad95e32"><td id=";SHN" class="" style="width:92.36666870117188px">Persistent?</td><td id="niyD" class="" style="width:33px">—</td><td id=":=ut" class="" style="width:33px">—</td><td id="p~[Q" class="" style="width:33px">—</td><td id="_wTM" class="" style="width:33px">—</td><td id="fB&gt;X" class="" style="width:33px">—</td><td id="N;~@" class="" style="width:33px">—</td><td id="[m``" class="" style="width:143.10000610351562px">Temp. Duplicated
    <br />(Internal Use Only)</td></tr></tbody></table></li></ul><ul id="26e23aa1-e084-4cad-a696-590de4fb8d37" class="bulleted-list"><li style="list-style-type:disc">Prev Ptr — If there is none, 0x000000 must be used</li></ul><ul id="5a86140e-6441-418e-91a8-a70aa7e8d2a3" class="bulleted-list"><li style="list-style-type:disc">Next Ptr — if there is none, 0xFFFFFF must be used</li></ul><p id="c6a4e73c-ebf0-4cef-af3d-b56b83ca5e60" class="">In order to figure out the true size of the binary/directory, one must traverse the entire cluster chain.</p><p id="286ab834-7c96-47cf-9585-b705f10d3c74" class="">Persistent clusters, once created, will not be moved/deleted until the flag is removed; even if the cluster is marked as damaged, it will not be purged. Identical to the “System” flag for the MS-DOS FAT. The only case persistent clusters can be moved is via growing of the FAT area (if your application requires having fixed position for the clusters, store the offset from the first valid file block, not the absolute block number.)</p><h3 id="4253ef69-6fc5-4429-8dd9-42da6efff2ec" class="">Directory File Contents</h3><table id="8f99a1b5-75f2-4d41-b3fb-28ae130019a2" class="simple-table"><tbody><tr id="1447e55f-710b-4988-85fb-232d82974756"><td id="pi?\" class="">entry size
    <br />(2 bytes)</td><td id="bPk;" class="">repetition: cluster numbers
    <br />(3*n bytes)</td></tr></tbody></table><ul id="4ca45d83-e0e4-4600-9298-201401df5a5e" class="bulleted-list"><li style="list-style-type:disc">Entry size is the occupying size of bytes, rather than cluster counts; the entry size will always be a multiple of 3</li></ul><ul id="8a6efaf3-888c-4ec0-a188-7bb7b0c59106" class="bulleted-list"><li style="list-style-type:disc">Entry size cannot exceed 4086 (1362×3) (cluster IDs that will actually fit in the remaining space)</li></ul><ul id="c1137bdb-59f3-4089-8b40-1b06181c4d79" class="bulleted-list"><li style="list-style-type:disc">If the length of the directory is longer than that, the remaining entries must be written on the next block of the file</li></ul><ul id="20596ae1-336c-4539-ba1b-99ff2d9e0eaf" class="bulleted-list"><li style="list-style-type:disc">‘.’ (current dir) and ‘..’ (parent dir) must be virtual: having them as a real file needlessly complicates the <code>renameTo</code> (<code>move</code>) operation</li></ul><ul id="84678c02-38ac-4161-858c-f257a3d0ad4c" class="bulleted-list"><li style="list-style-type:disc">Cluster numbers are recommended to be sorted within a cluster; in this mode, the complexity of searching will be <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.2/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mfrac><mrow><mi>log</mi><mo>⁡</mo><mn>1362</mn></mrow><mn>1362</mn></mfrac><mi>n</mi><mo stretchy="false">)</mo><mo>=</mo><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O({\log 1362 \over 1362}n) = O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.277216em;vertical-align:-0.345em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9322159999999999em;"><span style="top:-2.6550000000000002em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1362</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.446108em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mtight">l</span><span class="mtight">o</span><span class="mtight" style="margin-right:0.01389em;">g</span></span><span class="mspace mtight" style="margin-right:0.19516666666666668em;"></span><span class="mord mtight">1362</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span><span>﻿</span></span> — binary search on the first cluster, then second, and so on </li></ul><h3 id="f73b8864-e9cf-48fe-bcb3-2c81df56c447" class="">Binary File Contents</h3><table id="450fff73-8a39-4891-94e0-d0d0ac8a1498" class="simple-table"><tbody><tr id="8cb4662c-73a7-4f22-8af0-82591056bb68"><td id="@EQx" class=""># of bytes for this cluster
    <br />(2 bytes)</td><td id="KI=j" class="" style="width:484px">binary data
    <br />(up to 4086 bytes; unused area shall be filled with 0s but not guaranteed)</td></tr></tbody></table><ul id="e6dd8028-ff5a-4edf-bcd7-b91c608390fb" class="bulleted-list"><li style="list-style-type:disc">If the length of the file is longer than 4086 bytes, the remaining bytes must be written on the next block of the cluster chain</li></ul><ul id="a98ffb96-bb4d-4fa2-9ad7-1536d45cf396" class="bulleted-list"><li style="list-style-type:disc">0-byte files are advised to not have a cluster assigned and instead allocated as an Inline File</li></ul><h1 id="feb43a3f-dc67-4a72-8816-0012924e5fe9" class="">Filesystem-Special Files</h1><h2 id="553be37e-a668-4b04-b945-c797dc0cc923" class="">0xF0 — Copy-on-Write Siblings</h2><h3 id="f72673b7-bcff-488d-83f7-1ad5cfcc243c" class="">Structure</h3><table id="9fbd87a1-5597-4a77-8f24-49b9d19957f8" class="simple-table"><tbody><tr id="f4b327c8-92b6-4354-8b66-ab42741b6b1d"><th id="\_Cq" class="simple-table-header-color simple-table-header">Sibling 1</th><td id=";YOE" class="">file ID (3 bytes)</td><td id="wfSH" class="">file ID (3 bytes)</td><td id="JBl_" class="" style="width:33px">…</td><td id="}Zh]" class="">separator (0xFFFFFF)</td></tr><tr id="291cb1a2-8533-4a3b-b456-5f8b4ce8199a"><th id="\_Cq" class="simple-table-header-color simple-table-header">Sibling 2</th><td id=";YOE" class="">file ID (3 bytes)</td><td id="wfSH" class="">file ID (3 bytes)</td><td id="JBl_" class="" style="width:33px">…</td><td id="}Zh]" class="">separator (0xFFFFFF)</td></tr><tr id="27d47bfe-82fd-4b8b-8c48-05a51d8d6d09"><th id="\_Cq" class="simple-table-header-color simple-table-header">…</th><td id=";YOE" class="">…</td><td id="wfSH" class="">…</td><td id="JBl_" class="" style="width:33px">…</td><td id="}Zh]" class="">…</td></tr></tbody></table><p id="ed68ac47-b107-4915-82f5-cb7b2855fb94" class="">If CoW is implemented and enabled, any IO should refer to this file to see if the changing file has copies.</p><h1 id="6b419640-f057-4e3e-8774-51e5babb8af3" class="">When Does the File ID Change?</h1><ul id="eda8f766-c306-49eb-862e-4c811d04f505" class="bulleted-list"><li style="list-style-type:disc"><code>ClusteredFormatDOM.allocateFile</code><ul id="d355eb3d-0218-470a-89c3-3d7ed16eda18" class="bulleted-list"><li style="list-style-type:circle"><code>Clustfile.mkfat</code>, <code>Clustfile.initDir</code><ul id="c4fa161b-7477-49c9-9c7a-6657b24a3b48" class="bulleted-list"><li style="list-style-type:square">when the FAT area grows; reason: renumbering</li></ul></li></ul></li></ul><ul id="9b3f2e8d-07e0-4dc8-ade5-6ad1b5815f5b" class="bulleted-list"><li style="list-style-type:disc"><code>ClusteredFormatDOM.writeBytes</code><ul id="acd33dc2-3a12-4493-b68a-5a5f1bd0f53b" class="bulleted-list"><li style="list-style-type:circle"><code>Clustfile.overwrite</code>, <code>Clustfile.addChild</code>, <code>Clustfile.mkdir</code>, <code>Clustfile.createNewFile</code>, <code>Clustfile.removeChild</code>, <code>Clustfile.renameTo</code>, <code>Clustfile.pwrite</code><ul id="2d348d7e-6fa0-458f-8ee1-17204be05c5e" class="bulleted-list"><li style="list-style-type:square">when writing into inlined file, and the FAT area grows; reason: renumbering</li></ul><ul id="13f8d385-edd8-4904-a0d8-c3d9c0e98b2c" class="bulleted-list"><li style="list-style-type:square">when previously inlined file gets uninlined; reason: reassigning</li></ul><ul id="7fcb25c5-bb35-4a01-8c02-41fa82c817e3" class="bulleted-list"><li style="list-style-type:square"><del>when previously uninlined file gets inlined</del> (once inlined file will not be uninlined)</li></ul></li></ul></li></ul><h1 id="bd9d2930-9b77-4ff4-a5b5-ed403acc0587" class="">Functions</h1><h2 id="0e655231-d926-4c6c-a2f0-30551503bfd8" class="">Disk Management Functions</h2><h3 id="0cb7729d-fd52-4484-9c36-877e99609bcc" class="">private renum(increment: Int)</h3><p id="375d1f08-a7b0-4443-86c1-818c2e82d334" class="">Increments every number (block ptr) by given value.</p><h3 id="34bd866b-fdb4-42f0-af06-095ca25fd8b2" class="">public defrag(option: Int = 0)</h3><p id="23ec3e91-41d5-4cac-867d-7c3f746e0489" class="">Removes gaps between blocks if <code>option</code> is 0.</p><p id="11664a02-fce8-41d7-9dad-ca46d4be0755" class="">OPTIONAL — if <code>option</code> is 1, also makes the file blocks contiguous. Only beneficial if the host drive is rotational; SSDs will take no benefit and instead be worn down unnecessarily.</p><h3 id="dff465ff-f06e-4665-8df7-2234c4aece2b" class="">public growFAT()</h3><p id="8dc12d80-701c-49c9-a535-5eaaa42a2642" class="">Grows the size of the FAT to the next notch (<code>(2 + fatClusterCount) * 2 - 2</code>) followed by automatic call of the <code>renum</code>.</p><h3 id="2567a07c-202d-4521-9888-ffb6e59a065e" class="">public allocateFile(size: Int): FATEntry</h3><p id="4b05ec1a-8eef-4241-a176-5f8a0cdcff31" class="">Appends <code>ceil(size / 4096)</code> clusters to the end of the archive, creates the corresponding File Allocation entry, then returns the Entry.</p><h3 id="4fdbe9c6-f198-4968-8ba0-edcd49c54f98" class="">public getFile(clusterNumber: Int): FATEntry?</h3><p id="82c8fd88-3cd5-4788-baf8-fcc25f2da323" class="">Returns the FAT of the specified entry; returns <code>null</code> for non-existent entry.</p><h3 id="549018c9-7368-444c-9918-3f1e74818a4e" class="">public deleteFile(clusterNumber: Int)</h3><p id="0cb29e77-f0a1-47e9-80f1-1f0d8de0aaaa" class="">Marks the specified file as deleted.</p><ul id="ad8450fe-6f1b-440b-947c-c5d8db2784f9" class="bulleted-list"><li style="list-style-type:disc">Throws <code>IllegalArgumentException</code> if the entry number is root/bootsector/FAT clusters.</li></ul><ul id="a7d1f9d2-51f8-43bb-9fb0-4f73394be7ae" class="bulleted-list"><li style="list-style-type:disc">Throws <code>FileNotFoundException</code> if there is no file associated with the given cluster number.</li></ul><h3 id="f21501cc-fd2a-4708-a74a-180dac5c3518" class="">public writeBytes(entry: FATEntry, buffer: ByteArray, bufferOffset: Int, writeLength: Int, fileOffset: Int)</h3><p id="b1df921d-e232-4838-87a4-9bc6448e0ecb" class="">Copies the bytes on the <code>buffer</code> starting from the <code>bufferOffset</code> to the allocated clusters past the <code>fileOffset</code>, then updates the <code>number of bytes</code> property of the affected clusters. If <code>writeLength + fileOffset</code> is larger than the allocation, new clusters will be automatically added at the end of the archive.</p><p id="1ace56ea-7a9d-4928-9e52-80a7e1688634" class="">The behaviour will be identical even if the type of the file is not a binary file.</p><h3 id="519f86d4-8d14-4c1c-a429-bbd9c3f3c055" class="">public readBytes(entry: FATEntry, length: Int, offset: Int): ByteArray</h3><p id="5ac87745-ee47-4a91-9ecd-79d9b75ff95f" class="">Copies the bytes on the file starting from the <code>offset</code> to the new ByteArray, and returns the ByteArray. The length of the returning array may be smaller than the <code>length</code> argument.</p><p id="59192003-e4aa-4cf6-be11-97b7e730a628" class="">Internally, this function work as:</p><pre id="174213d4-f52f-495f-9a79-8f30b13f72c8" class="code"><code>val ba = ByteArray(length)
val actualSize = readBytes(entry, ba, 0, length, offset)

if (ba.size == actualSize) return ba

val ba2 = ByteArray(actualSize)
System.arraycopy(ba, 0, ba2, 0, actualSize)
return ba2</code></pre><h3 id="774a1cdf-57c4-4a38-bb96-e562adda624b" class="">public readBytes(entry: FATEntry, buffer: ByteArray, bufferOffset: Int, readLength: Int, readOffset: Int): Int</h3><p id="42166b88-f21e-4431-8d25-134b36e40caa" class="">Copies the bytes on the file starting from the <code>readOffset</code> to the given <code>buffer</code> past the <code>bufferOffset</code> and returns how many bytes are actually copied over. The returned value may be smaller than the <code>length</code> argument; reading will be interrupted when end-of-the-file or end-of-the-buffer is reached.</p><h3 id="d81660f6-ba50-4626-96fd-2fdfbaf69c84" class="">public setFileLength(entry: FATEntry, newLength: Int)</h3><p id="56d4d37b-1989-481a-920d-c79f98121373" class="">Modifies the <code>number of bytes</code> property of the clusters, starting from the beginning, so that the calculated file size would be same as the <code>newLength</code>. Any leftover clusters will be marked for deletion.</p><h3 id="8d306480-ead1-47db-a114-7fadfeecdf57" class="">public getFileLength(entry: FATEntry): Int</h3><p id="90e5a07f-c5c1-4a49-a6af-d8c13295a409" class="">Traverse the entire clusters to get the real length of the file.</p><h3 id="977e7a9e-fc9f-4fa5-82b4-56ae041b0f67" class="">public addSubEntry(entry: FATEntry, clusterNumbers: List&lt;Int&gt;)</h3><p id="2e3b2a1f-836a-4176-ae07-1c086413947e" class="">Directories only — will append the given entries to the directory listing, will all the necessary housekeeping on the background.</p><ul id="345c0827-6d42-45ab-8eae-2232263e132f" class="bulleted-list"><li style="list-style-type:disc">Throws <code>UnsupportedOperationException</code> if the file is not a directory</li></ul></div></article></body></html>